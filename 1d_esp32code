
#include <kol_inferencing.h>
#include <Wire.h>
#include <Adafruit_MPU6050.h>
#include <Adafruit_Sensor.h>

/* MPU object */
Adafruit_MPU6050 mpu;

/* Edge Impulse feature buffer */
static float features[EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE];
signal_t signal;

/* Sampling rate: 50 Hz */
const uint32_t sample_interval_ms = 20;

/* Edge Impulse signal callback */
int get_signal_data(size_t offset, size_t length, float *out_ptr) {
    memcpy(out_ptr, features + offset, length * sizeof(float));
    return 0;
}

void setup() {
    Serial.begin(115200);
    delay(1000);

    Serial.println("ESP32 booting...");

    /* ‚úÖ CRITICAL: Initialize I2C for ESP32 */
    Wire.begin(21, 22);

    Serial.println("I2C initialized");

    /* Initialize MPU6050 */
    if (!mpu.begin()) {
        Serial.println("‚ùå MPU6050 not detected!");
        while (true) {
            delay(100);   // watchdog-safe
        }
    }

    Serial.println("‚úÖ MPU6050 connected");

    /* Sensor configuration */
    mpu.setAccelerometerRange(MPU6050_RANGE_2_G);
    mpu.setGyroRange(MPU6050_RANGE_250_DEG);
    mpu.setFilterBandwidth(MPU6050_BAND_21_HZ);

    Serial.println("MPU6050 configured");

    /* Edge Impulse signal setup */
    signal.total_length = EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE;
    signal.get_data = &get_signal_data;

    Serial.println("üöÄ Edge Impulse inferencing started");
}

void loop() {
    size_t idx = 0;

    /* Collect one full window (1 second = 50 samples) */
    while (idx < EI_CLASSIFIER_DSP_INPUT_FRAME_SIZE) {

        sensors_event_t accel, gyro, temp;
        mpu.getEvent(&accel, &gyro, &temp);

        /* Accelerometer (m/s^2) */
        features[idx++] = accel.acceleration.x;
        features[idx++] = accel.acceleration.y;
        features[idx++] = accel.acceleration.z;

        /* Gyroscope (rad/s) */
        features[idx++] = gyro.gyro.x;
        features[idx++] = gyro.gyro.y;
        features[idx++] = gyro.gyro.z;

        delay(sample_interval_ms); // 50 Hz
    }

    ei_impulse_result_t result = {0};

    /* Run Edge Impulse classifier */
    EI_IMPULSE_ERROR res = run_classifier(&signal, &result, false);
    if (res != EI_IMPULSE_OK) {
        Serial.println("‚ùå Inference failed");
        return;
    }

    /* Print predictions */
    Serial.println("\nüìä Predictions:");
    for (size_t i = 0; i < EI_CLASSIFIER_LABEL_COUNT; i++) {
        Serial.print("  ");
        Serial.print(ei_classifier_inferencing_categories[i]);
        Serial.print(": ");
        Serial.println(result.classification[i].value, 4);
    }

#if EI_CLASSIFIER_HAS_ANOMALY
    Serial.print("‚ö†Ô∏è Anomaly score: ");
    Serial.println(result.anomaly, 4);
#endif

    Serial.println("-------------------------");
}
